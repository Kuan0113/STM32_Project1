|name |address(dec) |address(hex) |
|------|------|---------------|
|Device ID/Device Reset |0 |0x00 |
|CONFIGURATION - 1 |1 |0x01 |
CONFIGURATION - 2 |2 |0x02
CONFIGURATION - 3 |3 |0x03
LOW THRESHOLD - LOW BYTE |4 |0x04
LOW THRESHOLD - HIGH BYTE |5 |0x05
HIGH THRESHOLD - LOW BYTE |6 |0x06 
HIGH THRESHOLD - HIGH BYTE |7 |0x07 
STATUS FLAGS |8 |0x08 
GREEN DATA - LOW BYTE |9 |0x09 
GREEN DATA - HIGH BYTE |10 |0x0A
RED DATA - LOW BYTE |11 |0x0B 
RED DATA - HIGH BYTE |12 |0x0C 
BLUE DATA - LOW BYTE |13 |0x0D
BLUE DATA - HIGH BYTE |14 |0x0E

```
/* USER CODE BEGIN Includes */
#include "main.h"
#include <string.h>
#include <stdio.h>
/* USER CODE END Includes */

/* USER CODE BEGIN Private defines */
#define ISL29125_ADDR         (0x44 << 1)  // ISL29125 7-bit I2C address = 0x44

// Register map
#define ISL29125_REG_DEVICE_ID   0x00
#define ISL29125_REG_CONFIG1     0x01
#define ISL29125_REG_CONFIG2     0x02
#define ISL29125_REG_CONFIG3     0x03
#define ISL29125_REG_STATUS      0x08
#define ISL29125_REG_GREEN_L     0x09
#define ISL29125_REG_GREEN_H     0x0A
#define ISL29125_REG_RED_L       0x0B
#define ISL29125_REG_RED_H       0x0C
#define ISL29125_REG_BLUE_L      0x0D
#define ISL29125_REG_BLUE_H      0x0E

// Config bits (from datasheet)
#define CONFIG1_MODE_RGB         0x05   // RGB mode, 12-bit, 375 lux range (example)
#define CONFIG2_IR_ADJUST_HIGH   0x3F   // IR compensation (optional)
#define CONFIG3_INT_ON_COMPLETE  0x10   // Interrupt on conversion complete
/* USER CODE END Private defines */

/* USER CODE BEGIN Private variables */
extern I2C_HandleTypeDef hi2c1;  // generated by CubeMX
extern UART_HandleTypeDef huart2;  // for debug
/* USER CODE END Private variables */

/* USER CODE BEGIN Function prototypes */
HAL_StatusTypeDef ISL29125_WriteRegister(uint8_t reg, uint8_t value);
HAL_StatusTypeDef ISL29125_ReadRegister(uint8_t reg, uint8_t *value);
HAL_StatusTypeDef ISL29125_ReadRGB(uint16_t *r, uint16_t *g, uint16_t *b);
HAL_StatusTypeDef ISL29125_Init(void);
/* USER CODE END Function prototypes */

int main(void)
{
  /* HAL init stuff */
  HAL_Init();
  SystemClock_Config();
  MX_GPIO_Init();
  MX_I2C1_Init();
  MX_USART2_UART_Init();

  /* USER CODE BEGIN 2 */
  char msg[64];
  uint16_t r,g,b;

  if (ISL29125_Init() != HAL_OK) {
    strcpy(msg, "ISL29125 init failed!\r\n");
    HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);
    while(1);
  }
  strcpy(msg, "ISL29125 ready\r\n");
  HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);
  /* USER CODE END 2 */

  while (1)
  {
    /* USER CODE BEGIN WHILE */
    if (ISL29125_ReadRGB(&r,&g,&b) == HAL_OK) {
      int len = snprintf(msg, sizeof(msg), "R=%u G=%u B=%u\r\n", r,g,b);
      HAL_UART_Transmit(&huart2, (uint8_t*)msg, len, HAL_MAX_DELAY);
    }
    HAL_Delay(500);
    /* USER CODE END WHILE */
  }
}

/* USER CODE BEGIN 4 */
HAL_StatusTypeDef ISL29125_WriteRegister(uint8_t reg, uint8_t value)
{
  uint8_t buf[2] = {reg, value};
  return HAL_I2C_Master_Transmit(&hi2c1, ISL29125_ADDR, buf, 2, HAL_MAX_DELAY);
}

HAL_StatusTypeDef ISL29125_ReadRegister(uint8_t reg, uint8_t *value)
{
  HAL_StatusTypeDef ret;
  ret = HAL_I2C_Master_Transmit(&hi2c1, ISL29125_ADDR, &reg, 1, HAL_MAX_DELAY);
  if (ret != HAL_OK) return ret;
  return HAL_I2C_Master_Receive(&hi2c1, ISL29125_ADDR, value, 1, HAL_MAX_DELAY);
}

HAL_StatusTypeDef ISL29125_Init(void)
{
  HAL_StatusTypeDef ret;

  // Check device ID
  uint8_t id;
  ret = ISL29125_ReadRegister(ISL29125_REG_DEVICE_ID, &id);
  if (ret != HAL_OK) return ret;

  // Configure sensor: RGB mode
  ret = ISL29125_WriteRegister(ISL29125_REG_CONFIG1, CONFIG1_MODE_RGB);
  if (ret != HAL_OK) return ret;

  // Optional: extra configs
  ret = ISL29125_WriteRegister(ISL29125_REG_CONFIG2, CONFIG2_IR_ADJUST_HIGH);
  if (ret != HAL_OK) return ret;

  ret = ISL29125_WriteRegister(ISL29125_REG_CONFIG3, 0x00);
  return ret;
}

HAL_StatusTypeDef ISL29125_ReadRGB(uint16_t *r, uint16_t *g, uint16_t *b)
{
  uint8_t lo, hi;
  HAL_StatusTypeDef ret;

  // Green
  ret = ISL29125_ReadRegister(ISL29125_REG_GREEN_L, &lo);
  if (ret != HAL_OK) return ret;
  ret = ISL29125_ReadRegister(ISL29125_REG_GREEN_H, &hi);
  if (ret != HAL_OK) return ret;
  *g = (hi << 8) | lo;

  // Red
  ret = ISL29125_ReadRegister(ISL29125_REG_RED_L, &lo);
  if (ret != HAL_OK) return ret;
  ret = ISL29125_ReadRegister(ISL29125_REG_RED_H, &hi);
  if (ret != HAL_OK) return ret;
  *r = (hi << 8) | lo;

  // Blue
  ret = ISL29125_ReadRegister(ISL29125_REG_BLUE_L, &lo);
  if (ret != HAL_OK) return ret;
  ret = ISL29125_ReadRegister(ISL29125_REG_BLUE_H, &hi);
  if (ret != HAL_OK) return ret;
  *b = (hi << 8) | lo;

  return HAL_OK;
}
/* USER CODE END 4 */









